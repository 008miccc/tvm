name: android-tvm-unified-build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ANDROID_PLATFORM: 26
  ANDROID_NDK_VERSION: "25.2.9519653"

jobs:
  build-android-unified:
    name: Build Unified Android RPC (OpenCL + Vulkan)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install host deps
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk wget unzip cmake ninja-build zip

      - name: Setup Android SDK/NDK
        run: |
          SDKROOT="$HOME/android-sdk"
          mkdir -p "$SDKROOT/cmdline-tools"
          curl -fsSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o /tmp/cmdline.zip
          unzip -o /tmp/cmdline.zip -d "$SDKROOT/cmdline-tools"
          mv "$SDKROOT/cmdline-tools/cmdline-tools" "$SDKROOT/cmdline-tools/latest" || true
          yes | "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDKROOT" --install "platform-tools" "platforms;android-$ANDROID_PLATFORM" "ndk;$ANDROID_NDK_VERSION" "cmake;3.22.1"
          echo "ANDROID_SDK_ROOT=$SDKROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$SDKROOT/ndk/$ANDROID_NDK_VERSION" >> $GITHUB_ENV

      - name: Configure and Build
        run: |
          mkdir build && cd build
          # We enable both USE_OPENCL and USE_VULKAN in one build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI="arm64-v8a" \
            -DANDROID_PLATFORM="$ANDROID_PLATFORM" \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_CPP_RPC=ON \
            -DTVM_FFI_USE_LIBBACKTRACE=OFF \
            -DUSE_OPENCL=ON \
            -DUSE_VULKAN=ON \
            -DBUILD_SHARED_LIBS=ON \
            -G Ninja
          
          # CRITICAL: We explicitly target 'tvm_rpc' and 'runtime'
          ninja -j 2 runtime tvm_rpc

      - name: Package artifact
        run: |
          mkdir -p unified_rpc
          # Copy the server executable (found in apps/cpp_rpc within the build dir)
          cp build/apps/cpp_rpc/tvm_rpc unified_rpc/
          # Copy the unified runtime library
          cp build/libtvm_runtime.so unified_rpc/
          # Copy the NDK helper library
          find "$ANDROID_NDK_HOME" -name libc++_shared.so -print -quit | xargs -r -I{} cp {} unified_rpc/
          
          zip -r android_unified_rpc.zip unified_rpc
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-unified-rpc-server
          path: android_unified_rpc.zip
