name: Build TVM Linux Wheel

on:
  workflow_dispatch: # Allows manual execution

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout with submodules (Critical for TVM)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. Pre-Flight Checks
      # This step verifies the environment before starting the heavy work.
      - name: Pre-Flight Check
        run: |
          echo "=== Starting Pre-Flight Checks ==="
          echo "Current Directory: $(pwd)"
          
          # Check for Python folder and setup.py
          if [ -d "python" ] && [ -f "python/setup.py" ]; then
            echo "✅ Python directory and setup.py found."
          else
            echo "❌ ERROR: python/setup.py not found. Check if fork is complete."
            exit 1
          fi

          # Check for submodules (3rdparty should not be empty)
          if [ "$(ls -A 3rdparty/dmlc-core 2>/dev/null)" ]; then
            echo "✅ Submodules appear to be initialized."
          else
            echo "❌ ERROR: Submodules missing. Ensure 'submodules: recursive' is used."
            exit 1
          fi
          echo "=== Pre-Flight Checks Passed ==="

      # 3. Install System Dependencies
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev python3-pip cmake ninja-build \
                               llvm-dev libtinfo-dev zlib1g-dev libedit-dev ccache

      # 4. Setup C++ Cache
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-tvm-ccache
          max-size: 2G

      # 5. Configure Build
      - name: Configure TVM
        run: |
          mkdir -p build
          cp cmake/config.cmake build/ || true
          cd build
          # Use ccache to ensure we can 'continue' builds faster next time
          cmake -G Ninja .. \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DUSE_LLVM=ON \
            -DUSE_RPC=ON \
            -DUSE_GRAPH_EXECUTOR=ON
            
      # 6. Compile C++ Core
      - name: Build C++ Core
        run: |
          cd build
          ninja -j $(nproc)

      # 7. Create Python Wheel
      - name: Build Wheel
        env:
          TVM_LIBRARY_PATH: ${{ github.workspace }}/build
        run: |
          python3 -m pip install --upgrade pip wheel setuptools
          cd python
          python3 setup.py bdist_wheel
          
          mkdir -p ../dist-out
          cp dist/*.whl ../dist-out/

      # 8. Upload Result
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tvm-linux-wheel
          path: dist-out/*.whl
