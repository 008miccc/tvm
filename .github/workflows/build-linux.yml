name: TVM Linux Wheel

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-dev python3-pip python3-setuptools python3-wheel \
                             cmake ninja-build llvm-dev libtinfo-dev zlib1g-dev libedit-dev

      - name: Configure TVM build
        run: |
          mkdir build
          cp cmake/config.cmake build/ || true
          cd build
          cmake -G Ninja .. \
            -DUSE_LLVM=ON \
            -DUSE_RPC=ON \
            -DUSE_GRAPH_EXECUTOR=ON

      - name: Build TVM C++ core
        run: |
          cd build
          ninja -j 2

      - name: Build and package Python wheel
        run: |
          python3 -m pip install --upgrade pip wheel setuptools
          # Locate setup.py in the repo
          SETUP_PY=$(find . -maxdepth 4 -type f -name setup.py | head -n 1 || true)
          if [ -z "$SETUP_PY" ]; then
            echo "ERROR: no setup.py found in repo; aborting"
            exit 1
          fi
          SETUP_DIR=$(dirname "$SETUP_PY")
          echo "Found setup.py at: $SETUP_PY (dir: $SETUP_DIR)"
          cd "$SETUP_DIR"
          python3 setup.py bdist_wheel
          mkdir -p "$GITHUB_WORKSPACE/wheel-linux"
          cp dist/*.whl "$GITHUB_WORKSPACE/wheel-linux/" || true

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: tvm-linux-wheel
          path: wheel-linux/*.whl
